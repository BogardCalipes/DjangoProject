{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Playground - {{ problem.problem_title }}</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
body { background-color: #1E2835; color: #e0e0e0; }
.card { background-color: #212529; color: #e0e0e0; border-radius: 8px; border: 1px solid #2b3a55; margin-bottom: 15px; }
.card-header { background-color: #1E2835; color: #00cc66; font-weight: bold; }
.editor-container { height: 500px; position: relative; }
.language-select { position: absolute; top: 10px; right: 10px; width: 120px; font-size: 0.85rem; z-index: 10; }
.test-case-box { background: #12181f; color: #00ff99; padding: 10px; border-radius: 6px; font-family: monospace; margin-bottom: 10px; border: 1px solid #2b3a55; }
#codeEditor { height: 100%; width: 100%; font-size: 14px; }
textarea#userInput { width: 100%; background: #12181f; color: #00ff99; border: 1px solid #2b3a55; border-radius: 6px; font-family: monospace; padding: 8px; margin-bottom: 10px; }
</style>
</head>
<body>
<div class="container-fluid mt-4">
  <div class="row">
    <!-- Problem Details -->
    <div class="col-md-3">
      <div class="card">
        <div class="card-header">Problem Details</div>
        <div class="card-body">
          <h5 class="card-title text-success">{{ problem.problem_title }}</h5>
          <p class="card-text">{{ problem.problem_description }}</p>
        </div>
      </div>
      <div class="card">
        <div class="card-header">Test Cases (Input)</div>
        <div class="card-body">
          {% for tc in problem.problemtestcase_set.all %}
          <div class="test-case-box">Input {{ forloop.counter }}: {{ tc.input_data }}</div>
          {% empty %}
          <div>No test cases available.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Code Editor -->
    <div class="col-md-6">
      <div class="card editor-container">
        <select id="language" class="form-select language-select bg-dark text-white">
          <option value="python">Python</option>
          <option value="c">C</option>
          <option value="cpp">C++</option>
          <option value="java">Java</option>
        </select>
        <div id="codeEditor"># Write your code here</div>
      </div>
      <textarea id="userInput" placeholder="Enter input for input() calls here..."></textarea>
      <div class="d-flex justify-content-between mt-2">
        <button class="btn btn-success" onclick="runCode(false)" data-bs-toggle="modal" data-bs-target="#terminalModal">‚ñ∂ Run Code</button>
        <button class="btn btn-primary" onclick="runCode(true)" data-bs-toggle="modal" data-bs-target="#checkModal">üß© Check Code</button>
      </div>
    </div>

    <!-- Expected Output -->
    <div class="col-md-3">
  <div class="card">
    <div class="card-header">Expected Output</div>
    <div class="card-body">
      {% for tc in problem.problemtestcase_set.all %}
        <div class="test-case-box">
          {{ tc.expected_output|linebreaksbr }}
          <br>
        </div>
      {% empty %}
        <div>No expected outputs available.</div>
      {% endfor %}
    </div>
  </div>
</div>

  </div>
</div>

<!-- Terminal Modal -->
<div class="modal fade" id="terminalModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="background-color:#12181f; color:white;">
      <div class="modal-header">
        <h5 class="modal-title">Terminal Output</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <pre id="terminalOutput" style="white-space: pre-wrap; font-family: monospace; color:#00ff99;">Waiting for code execution...</pre>
      </div>
    </div>
  </div>
</div>

<!-- Check Result Modal -->
<div class="modal fade" id="checkModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background-color:#12181f; color:white;">
      <div class="modal-header">
        <h5 class="modal-title">Code Check Result</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="checkResult" style="white-space: pre-wrap; font-family: monospace;"></div>
      </div>
      <div class="modal-footer">
        <!-- ‚úÖ Always visible after checking -->
        <button type="button" class="btn btn-success" id="submitBtn" onclick="submitCode()" style="display:none;">
          ‚úÖ Submit Code & Score
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Ace Editor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ext-language_tools.js"></script>
<script>
let editor = ace.edit("codeEditor");
editor.setTheme("ace/theme/dracula");
editor.session.setMode("ace/mode/python");
editor.setOptions({
  enableBasicAutocompletion: true,
  enableLiveAutocompletion: true,
  fontSize: "14px",
  showPrintMargin: false,
  highlightActiveLine: true,
  tabSize: 4,
  useSoftTabs: true
});

const languageModes = {
  python: "ace/mode/python",
  c: "ace/mode/c_cpp",
  cpp: "ace/mode/c_cpp",
  java: "ace/mode/java"
};
document.getElementById("language").addEventListener("change", e => {
  editor.session.setMode(languageModes[e.target.value]);
});

function getCode() { return editor.getValue(); }

async function runCode(checkMode=false) {
  const code = getCode();
  const lang = document.getElementById('language').value;
  const problemId = "{{ problem.problem_id }}";
  const stdinData = document.getElementById('userInput').value;
  const url = "{% url 'run_playground_code' %}";
  const modalOutput = checkMode ? document.getElementById('checkResult') : document.getElementById('terminalOutput');
  modalOutput.textContent = "Running...";

  try {
    const response = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({ 
        code, language: lang, check_mode: checkMode, problem_id: problemId, stdin: stdinData
      })
    });

    const data = await response.json();
    if (data.error) { modalOutput.textContent = "‚ö†Ô∏è " + data.error; return; }

    if (checkMode) {
      modalOutput.innerHTML = `<pre style="color:#28a745;">${data.result_summary}</pre>`;
      // ‚úÖ Always show submit button after checking
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.style.display = 'inline-block';
    } else {
      modalOutput.textContent = data.output || "No output.";
    }

  } catch (err) {
    modalOutput.textContent = "‚ö†Ô∏è Failed to connect to server: " + err.message;
    console.error(err);
  }
}

async function submitCode() {
  const code = getCode();
  const problemId = "{{ problem.problem_id }}";
  const lang = document.getElementById('language').value;

  try {
    const response = await fetch("{% url 'submit_problem' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        problem_id: problemId,
        code: code,
        language: lang
      })
    });

    // ‚úÖ Clone the response so we can safely read it as text if JSON parsing fails
    const resClone = response.clone();

    let data;
    try {
      data = await response.json();
    } catch (err) {
      const text = await resClone.text();
      console.error("Server returned non-JSON response:", text);
      alert("‚ö†Ô∏è Server error (non-JSON). Check console for details.");
      return;
    }

    if (data.success) {
  alert("‚úÖ " + data.message);
  const redirect = data.redirect_url || "{% url 'StudentClass' %}";
    // wait a bit before redirect to let user see the alert
    setTimeout(() => {
      window.location.href = redirect;
    }, 500);
  } else {
    alert("‚ö†Ô∏è " + (data.message || "Submission failed."));
  }


  } catch (error) {
    alert("‚ö†Ô∏è Submission failed: " + error.message);
    console.error(error);
  }
}



</script>
</body>
</html>
