{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Playground - {{ problem.problem_title }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- CodeMirror 6 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@codemirror/theme-one-dark@0.19.5/dist/index.min.css">

  <style>
    body { background-color: #1E2835; color: #e0e0e0; }
    .card { background-color: #212529; color: #e0e0e0; border-radius: 8px; border: 1px solid #2b3a55; margin-bottom: 15px; }
    .card-header { background-color: #1E2835; color: #00cc66; font-weight: bold; }
    .editor-container { height: 500px; position: relative; }
    .language-select { position: absolute; top: 10px; right: 10px; width: 120px; font-size: 0.85rem; z-index: 10; }
    .test-case-box { background: #12181f; color: #00ff99; padding: 10px; border-radius: 6px; font-family: monospace; margin-bottom: 10px; border: 1px solid #2b3a55; }
    .btn-success { background-color: #28a745; border-color: #28a745; }
    .btn-success:hover { background-color: #1e7e34; border-color: #1c7430; }
    .btn-primary { background-color: #0d6efd; border-color: #0d6efd; }
    .btn-primary:hover { background-color: #0b5ed7; border-color: #0a58ca; }
  </style>
</head>
<body>

<div class="container-fluid mt-4">
  <div class="row">
    <!-- Problem Details -->
    <div class="col-md-3">
      <div class="card">
        <div class="card-header">Problem Details</div>
        <div class="card-body">
          <h5 class="card-title text-success">{{ problem.problem_title }}</h5>
          <p class="card-text">{{ problem.problem_description }}</p>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Test Cases (Input)</div>
        <div class="card-body">
          {% for tc in problem.problemtestcase_set.all %}
          <div class="test-case-box">Input {{ forloop.counter }}: {{ tc.input_data }}</div>
          {% empty %}
          <div>No test cases available.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Code Editor -->
    <div class="col-md-6">
      <div class="card editor-container">
        <select id="language" class="form-select language-select bg-dark text-white">
          <option value="python">Python</option>
          <option value="c">C</option>
          <option value="cpp">C++</option>
          <option value="java">Java</option>
        </select>
        <div id="codeEditor" style="height: 100%; width: 100%;" tabindex="0"></div>
      </div>
      <div class="d-flex justify-content-between mt-2">
        <button class="btn btn-success" onclick="runCode(false)" data-bs-toggle="modal" data-bs-target="#terminalModal">‚ñ∂ Run Code</button>
        <button class="btn btn-primary" onclick="runCode(true)" data-bs-toggle="modal" data-bs-target="#checkModal">üß© Check Code</button>
      </div>
    </div>

    <!-- Expected Output -->
    <div class="col-md-3">
      <div class="card">
        <div class="card-header">Expected Output</div>
        <div class="card-body">
          {% for tc in problem.problemtestcase_set.all %}
          <div class="test-case-box">Output {{ forloop.counter }}: {{ tc.expected_output }}</div>
          {% empty %}
          <div>No expected outputs available.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Terminal Modal -->
<div class="modal fade" id="terminalModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="background-color:#12181f; color:white;">
      <div class="modal-header">
        <h5 class="modal-title">Terminal Output</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <pre id="terminalOutput" style="white-space: pre-wrap; font-family: monospace; color:#00ff99;">Waiting for code execution...</pre>
      </div>
    </div>
  </div>
</div>

<!-- Check Result Modal -->
<div class="modal fade" id="checkModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background-color:#12181f; color:white;">
      <div class="modal-header">
        <h5 class="modal-title">Code Check Result</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="checkResult" style="white-space: pre-wrap; font-family: monospace;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">Enhance</button>
        <button type="button" class="btn btn-primary" id="submitScore">Submit</button>
      </div>
    </div>
  </div>
</div>

<!-- CodeMirror 6 JS -->
<script type="module">
import {EditorState} from "https://cdn.jsdelivr.net/npm/@codemirror/state@0.19.1/dist/index.min.js";
import {EditorView, keymap, highlightActiveLine} from "https://cdn.jsdelivr.net/npm/@codemirror/view@0.19.45/dist/index.min.js";
import {defaultKeymap, history, historyKeymap} from "https://cdn.jsdelivr.net/npm/@codemirror/commands@0.19.9/dist/index.min.js";
import {closeBrackets, closeBracketsKeymap} from "https://cdn.jsdelivr.net/npm/@codemirror/autocomplete@0.19.12/dist/index.min.js";
import {oneDark} from "https://cdn.jsdelivr.net/npm/@codemirror/theme-one-dark@0.19.5/dist/index.min.js";
import {python} from "https://cdn.jsdelivr.net/npm/@codemirror/lang-python@0.19.4/dist/index.min.js";
import {java} from "https://cdn.jsdelivr.net/npm/@codemirror/lang-java@0.19.4/dist/index.min.js";
import {cpp} from "https://cdn.jsdelivr.net/npm/@codemirror/lang-cpp@0.19.2/dist/index.min.js";
import {indentUnit} from "https://cdn.jsdelivr.net/npm/@codemirror/language@0.19.7/dist/index.min.js";

const languageModes = { python, c: cpp, cpp, java };

function createEditor(lang = "python", content = "") {
  const parent = document.getElementById("codeEditor");
  parent.innerHTML = "";
  return new EditorView({
    state: EditorState.create({
      doc: content,
      extensions: [
        keymap.of([...defaultKeymap, ...closeBracketsKeymap, ...historyKeymap]),
        closeBrackets(),
        highlightActiveLine(),
        history(),
        oneDark,
        indentUnit.of("    "),
        languageModes[lang]()
      ]
    }),
    parent: parent
  });
}

let editor = createEditor();

document.getElementById("language").addEventListener("change", e => {
  const lang = e.target.value;
  const content = editor.state.doc.toString();
  editor.destroy();
  editor = createEditor(lang, content);
});

function getCode() { return editor.state.doc.toString(); }

async function runCode(checkMode=false){
  const code = getCode();
  const lang = document.getElementById('language').value;
  const problemId = "{{ problem.problem_id }}";
  const url = "{% url 'run_playground_code' %}";
  const modalOutput = checkMode ? document.getElementById('checkResult') : document.getElementById('terminalOutput');
  modalOutput.textContent = "Running...";

  try {
    const response = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({ code, language: lang, check_mode: checkMode, problem_id: problemId })
    });

    const data = await response.json();

    if(data.error){
      modalOutput.textContent = "‚ö†Ô∏è " + data.error;
      return;
    }

    if(checkMode){
      const totalScore = Number("{{ problem.total_score }}");
      const passedAll = data.score === totalScore;
      const color = passedAll ? "#28a745" : "#dc3545";
      modalOutput.innerHTML = `<span style="color:${color}">${data.result_summary.replace(/\n/g,"<br>")}</span>`;

      document.getElementById("submitScore").onclick = async () => {
        alert("Score submitted: " + data.score);
        location.reload();
      };
    } else {
      modalOutput.textContent = data.output || "No output.";
    }

  } catch(err){
    modalOutput.textContent = "‚ö†Ô∏è Failed to connect to server.";
  }
}
</script>

</body>
</html>
