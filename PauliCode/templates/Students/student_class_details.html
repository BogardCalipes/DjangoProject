{% load static %}
{% include "partials/header.html" %}

<body class="g-sidenav-show text-white" style="background-color: #1E2835;">
  <div class="min-height-300 position-absolute w-100"></div>
  {% include "partials/StudentSidebar.html" %}

  <main class="main-content position-relative border-radius-lg p-4">

    <!-- CLASS HEADER -->
    <div class="card bg-dark p-4 border-0 shadow-sm rounded-4" style="margin-top: -5px; margin-bottom: 20px;">
      <div class="d-flex justify-content-between align-items-start flex-wrap mb-3">
        <div class="flex-grow-1">
          <h3 class="fw-bold text-white mb-2">{{ class.title }}</h3>
          <p class="text-muted small mb-0">{{ class.description }}</p>
        </div>

        <div class="d-flex align-items-center mt-2 mt-md-0">
          <!-- Unenroll Button -->
          <a href="{% url 'unenroll_class' class.class_id %}" 
             class="btn btn-outline-danger fw-bold align-items-center"
             onclick="return confirm('Are you sure you want to unenroll from this class?');">
            <img src="{% static 'img/deleteIcon.png' %}" alt="unenroll" style="width: 18px; height: 18px;" class="me-2">
            Unenroll
          </a>
        </div>
      </div>

      <div class="mt-3">
        <span class="badge bg-success px-3 py-2">{{ class.class_code }}</span>
      </div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <div class="row g-4">

      <!-- LEFT COLUMN (Problems Section only) -->
      <div class="col-12">
        <div class="card bg-dark border-0 shadow-sm text-white rounded-4 p-3">

          <!-- Search and Filter -->
          <form method="GET"
                class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3"
                style="margin-top: -10px;">
            
            <!-- Title -->
            <h5 class="fw-bold text-white mb-0 d-flex align-items-center flex-shrink-0">
              <img src="{% static 'img/problemsIcon.png' %}" alt="Problems Icon" width="25" height="25" class="me-2">
              Problems
            </h5>

            <!-- Search -->
            <div class="flex-grow-1 d-flex justify-content-center">
              <input type="text" name="q" value="{{ query }}"
                     class="form-control form-control-sm text-white border-0 shadow-sm"
                     placeholder="Search problems..."
                     style="max-width: 350px; background-color: rgb(37,36,36);">
            </div>

            <!-- Filters -->
            <div class="d-flex flex-wrap justify-content-center align-items-center gap-2">
              <span class="text-white fw-semibold">Quick Filter:</span>
              <button type="submit" name="filter" value="Assignment"
                data-filter="Assignment"
                class="btn btn-warning btn-sm fw-bold px-3 my-3 {% if filter_type == 'Assignment' %}active{% endif %}">
                Assignments
              </button>
              <button type="submit" name="filter" value="Quiz"
                      data-filter="Quiz"
                      class="btn btn-success btn-sm fw-bold px-3 my-3 {% if filter_type == 'Quiz' %}active{% endif %}">
                Quizzes
              </button>
            </div>
          </form>

          <!-- Problems List (Read-Only) -->
          {% if problems %}
          <div class="row g-3">
            {% for problem in problems %}
            <div class="col-md-6">
              <div class="card bg-transparent text-white border 
                          {% if problem.problem_type == 'Quiz' %}border-success{% else %}border-warning{% endif %}
                          rounded-3 p-3 shadow-sm h-100 problem-card"
                   data-problem-id="{{ problem.problem_id }}"
                   style="cursor: pointer;">
                <div class="d-flex justify-content-between align-items-start">
                  <h6 class="fw-bold mb-2 text-white">{{ problem.problem_title }}</h6>
                  <span class="badge 
                    {% if problem.problem_type == 'Quiz' %}bg-success{% else %}bg-warning text-dark{% endif %}">
                    Due: {{ problem.due_date|date:"M d, Y H:i" }}
                  </span>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="p-3 rounded-3 text-center text-muted"
               style="min-height: 316px; background-color: rgb(37,36,36);">
            <p>No problems yet.</p>
          </div>
          {% endif %}
        </div>
      </div>

    </div>

  </main>

 <!-- PROBLEM DETAILS MODAL -->
<div class="modal fade" id="problemDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered"> <!-- changed modal-xl -> modal-lg -->
    <div class="modal-content text-white" style="background-color: #1E2835; border-radius: 15px; max-width: 800px; margin: auto;">
      
      <!-- Header -->
      <div class="modal-header border-0 pb-0">
        <h4 class="fw-bold text-success">Problem Details</h4>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- Body -->
      <div class="modal-body px-4 pb-3">
        <div class="container-fluid">

          <!-- TOP ROW: Title & Instruction -->
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="fw-semibold mb-1">Title</label>
              <div id="problem_title" class="p-2 rounded" style="background:#101826; border:1px solid #2b3a55;"></div>
            </div>
            <div class="col-md-6">
              <label class="fw-semibold mb-1">Instruction</label>
              <div id="problem_description" class="p-2 rounded" style="background:#101826; border:1px solid #2b3a55; min-height:120px;"></div>
            </div>
          </div>

          <!-- SECOND ROW: Score & Due Date -->
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="fw-semibold mb-1">Score</label>
              <div id="total_score" class="p-2 rounded" style="background:#101826; border:1px solid #2b3a55;"></div>
            </div>
            <div class="col-md-6">
              <label class="fw-semibold mb-1">Due Date</label>
              <div id="due_date" class="p-2 rounded" style="background:#101826; border:1px solid #2b3a55;"></div>
            </div>
            <div class="col-md-6">
              <label class="fw-semibold mb-1">Time Limit</label>
              <div id="time_limit" class="p-2 rounded" style="background:#101826; border:1px solid #2b3a55;"></div>
            </div>
            <div class="col-md-6">
              <label class="fw-semibold mb-1">Type</label>
              <div id="problem_type" class="p-2 rounded" style="background:#101826; border:1px solid #2b3a55;"></div>
            </div>
          </div>

          <!-- THIRD ROW: Time Limit & Type -->
          <div class="row g-3 mb-3">
            
          </div>

          <!-- TEST CASES -->
          <div class="row g-2">
            <div class="col-12">
              <label class="fw-semibold mb-2">Test Cases</label>
              <div class="row g-2" id="test_cases_container"></div>
            </div>
          </div>

        </div>
      </div>

    
      <!-- Footer -->
      <div class="modal-footer border-0 d-flex justify-content-between pt-0">
        <button type="button" class="btn btn-outline-light px-4" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success px-4" id="answerButton">Answer</button>
      </div>


    </div>
  </div>
</div>




  {% include "partials/footer.html" %}
  {% include "partials/scripts.html" %}

  <!-- SEARCH & FILTER JS -->
  <script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form');
  const searchInput = form.querySelector('input[name="q"]');
  const filterButtons = document.querySelectorAll('button[name="filter"]');
  const currentFilter = "{{ filter_type|default:'' }}";

  filterButtons.forEach(btn => {
    btn.addEventListener('click', function(e) {
      const clickedFilter = this.dataset.filter;
      const searchValue = searchInput.value.trim();
      if (currentFilter === clickedFilter) {
        e.preventDefault();
        const url = new URL(window.location.href);
        url.searchParams.delete('filter');
        if (searchValue) url.searchParams.set('q', searchValue);
        window.location.href = url.toString();
      }
    });
  });

  searchInput.addEventListener('input', function() {
    if (this.value.trim() === '') {
      const url = new URL(window.location.href);
      url.searchParams.delete('q');
      window.location.href = url.toString();
    }
  });

  form.addEventListener('submit', function(e) {
    if (searchInput.value.trim() === '') {
      const url = new URL(window.location.href);
      url.searchParams.delete('q');
      if (currentFilter) url.searchParams.set('filter', currentFilter);
      window.location.href = url.toString();
      e.preventDefault();
    }
  });
});
  </script>

 <script>
document.querySelectorAll('.problem-card').forEach(card => {
  card.addEventListener('click', function() {
    const problemId = this.dataset.problemId;
    if (!problemId) return;

    fetch(`/problem/${problemId}/details/`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('problem_title').textContent = data.title;
        document.getElementById('problem_description').textContent = data.description;
        document.getElementById('problem_type').textContent = data.type;
        document.getElementById('total_score').textContent = data.score;
        document.getElementById('time_limit').textContent = data.time_limit;
        document.getElementById('due_date').textContent = data.due_date;

        // Populate test cases
        const container = document.getElementById('test_cases_container');
        container.innerHTML = '';
        data.test_cases.forEach((tc, index) => {
          const col = document.createElement('div');
          col.className = 'col-12';
          col.innerHTML = `
            <div class="p-2 mb-2 rounded" style="background:#121f3d; border:1px solid #2b3a55;">
              <strong>Input ${index+1}:</strong>
              <pre style="margin:0; white-space:pre-wrap;">${tc.input}</pre>
            </div>
            <div class="p-2 mb-3 rounded" style="background:#121f3d; border:1px solid #2b3a55;">
              <strong>Output ${index+1}:</strong>
              <pre style="margin:0; white-space:pre-wrap;">${tc.output}</pre>
            </div>
          `;
          container.appendChild(col);
        });

        // Set Answer button link dynamically
        const answerBtn = document.getElementById('answerButton');
        answerBtn.onclick = () => {
          window.location.href = `/playground/${problemId}/`;
        };

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('problemDetailsModal'));
        modal.show();
      });
  });
});
</script>


  <style>
    .btn-success { background-color: #00C98D; border: none; }
    .btn-success:hover { background-color: #00b07d; }
    .btn-danger { background-color: #ff4b5c; border: none; }
    .btn-danger:hover { background-color: #e63b4b; }
    .card { background-color: #2C3648 !important; }
    .small-placeholder::placeholder { font-size: 0.65rem; color: #b0b0b0; }
  </style>
</body>
</html>
